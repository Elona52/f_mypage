<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.project.reservation.mapper.ReservationMapper">

    <resultMap id="reservationMap" type="com.project.reservation.domain.Reservation">
        <id property="rsvId" column="rsv_id"/>
        <result property="usrId" column="usr_id"/>
        <result property="schdId" column="schd_id"/>
        <result property="tktId" column="tkt_id"/>
        <result property="sttsCd" column="stts_cd"/>
        <result property="regDt" column="reg_dt"/>
        <result property="cnclRsn" column="cncl_rsn"/>
        <result property="modUsrId" column="mod_usr_ID"/>
    </resultMap>

    <!-- 전체 조회 -->
    <select id="findAll" resultMap="reservationMap">
        SELECT * FROM reservation 
        ORDER BY reg_dt DESC
    </select>

    <!-- 단건 조회 -->
    <select id="findById" resultMap="reservationMap">
        SELECT * FROM reservation 
        WHERE rsv_id = #{id}
    </select>

    <!-- 사용자별 예약 조회 -->
    <select id="findByUser" resultMap="reservationMap">
        SELECT * FROM reservation 
        WHERE usr_id = #{userId} 
        ORDER BY reg_dt DESC
    </select>

    <!-- 상태코드별 예약 조회 -->
    <select id="findByPaymentStatus" resultMap="reservationMap">
        SELECT * FROM reservation 
        WHERE stts_cd = #{paymentStatus} 
        ORDER BY reg_dt DESC
    </select>

    <!-- 사용자별 + 상태코드별 예약 조회 -->
    <select id="findByUserAndPaymentStatus" resultMap="reservationMap">
        SELECT * FROM reservation 
        WHERE usr_id = #{userId} 
        AND stts_cd = #{paymentStatus} 
        ORDER BY reg_dt DESC
    </select>

    <!-- 등록 -->
    <insert id="insert" useGeneratedKeys="true" keyProperty="rsvId">
        INSERT INTO reservation (usr_id, schd_id, tkt_id, stts_cd, reg_dt, cncl_rsn, mod_usr_ID)
        VALUES (#{usrId}, #{schdId}, #{tktId}, 
                COALESCE(#{sttsCd}, '예약완료'), 
                NOW(), #{cnclRsn}, #{modUsrId})
    </insert>

    <!-- 수정 -->
    <update id="update">
        UPDATE reservation
        SET usr_id = #{usrId},
            schd_id = #{schdId},
            tkt_id = #{tktId},
            stts_cd = #{sttsCd},
            cncl_rsn = #{cnclRsn},
            mod_usr_ID = #{modUsrId}
        WHERE rsv_id = #{rsvId}
    </update>

    <!-- 상태코드만 수정 -->
    <update id="updatePaymentStatus">
        UPDATE reservation
        SET stts_cd = #{paymentStatus}
        WHERE rsv_id = #{id}
    </update>

    <!-- 소프트 삭제 (상태코드를 취소로 변경) -->
    <update id="softDelete">
        UPDATE reservation
        SET stts_cd = '취소'
        WHERE rsv_id = #{id}
    </update>

    <!-- 물리적 삭제 (관리자용) -->
    <delete id="delete">
        DELETE FROM reservation WHERE rsv_id = #{id}
    </delete>

</mapper>

